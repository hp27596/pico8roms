pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
-- thor game by hp
-- init
function _init()
 p = { x=20,
       y=88,
       spr=1,
       w=8,
       h=8,
       flipped=false,
       dx=0,
       dy=0,
       max_dx=2,
       max_dy=3,
       ax=0.5,
       ay=3.5,
       anim=0,
       running=false,
       jumping=false,
       falling=false,
       landed=false,
       sliding=false
 }
 h = { x=p.x+5,
       y=p.y-3,
       spr=16,
       w=8,
       h=8,
       dx=0,
       dy=0,
       max_dx=4,
       max_dy=5,
       ax=0.2,
       ay=0.5,
       anim=0,
       held=true,
       thrown=false,
       pulled=false,
 }

 grav=0.3
 fric=0.85
end

-- collision
function collide_map(obj,aim,flag)
 -- obj needs x,y,w,h
 local x=obj.x local y=obj.y
 local w=obj.w local h=obj.h

 -- coordinate check
 local x1=0 local y1=0
 local x2=0 local y2=0

 if aim=="left" then
  x1=x-1    y1=y
  x2=x      y2=y+h-1
 elseif aim=="right" then
  x1=x+w    y1=y
  x2=x+w+1  y2=y+h-1
 elseif aim=="up" then
  x1=x+1    y1=y-1
  x2=x+w-1  y2=y
 elseif aim=="down" then
  x1=x    y1=y+h
  x2=x+w  y2=y+h
 end

 -- pixels to tiles
 x1/=8 y1/=8
 x2/=8 y2/=8

 if fget(mget(x1,y1), flag)
 or fget(mget(x1,y2), flag)
 or fget(mget(x2,y1), flag)
 or fget(mget(x2,y2), flag) then
  return true
 else
  return false
 end
end

-- player update
function player_update()
 p.dy+=grav
 p.dx*=fric

 -- button controls
 if(btn(0)) p.dx-=p.ax p.running=true p.flipped=true
 if(btn(1)) p.dx+=p.ax p.running=true p.flipped=false
 if(btnp(5)) and p.landed then
  p.dy-=p.ay
  p.landed=false
 end
 -- if(btn(3)) p.

 -- slide
 if p.running
 and not btn(0)
 and not btn(1)
 and not p.falling
 and not p.jumping then
  p.running=false
  p.sliding=true
 end

 -- check collision vertical
 if p.dy>0 then
  p.falling=true
  p.landed=false
  p.jumping=false
  if collide_map(p,"down",0) then
   p.landed=true
   p.falling=false
   p.dy=0
   p.y-=(p.y+p.h)%8
  end
 elseif p.dy<0 then
  p.jumping=true
  if collide_map(p,"up",1) then
   p.dy=0
  end
 end

 -- check collision horizontal
 if p.dx<0 then
  if collide_map(p,"left",1) then
   p.dx=0
  end
 elseif p.dx>0 then
  if collide_map(p,"right",1) then
   p.dx=0
  end
 end

 -- stop sliding
 if p.sliding then
  if abs(p.dx)<1
  or p.running then
   p.dx=0
   p.sliding=false
  end
 end

 p.x+=p.dx
 p.y+=p.dy

end

-- hammer update
function hammer_update()
 h.y=p.y-3
 h.x+=h.dx

 if h.held then
  if p.flipped then
   h.x=p.x-5
  else
   h.x=p.x+5
  end
 end

 -- change hammer state when press button
 if btnp(4) then
  h.dx=0
  if h.thrown then
   h.thrown=false
   h.pulled=true
  else
   h.thrown=true
   if p.flipped then
    h.flipped=true
   else
    h.flipped=false
   end
  end
 end

 -- catching the hammer
 if abs(h.x-p.x)<8 then
  h.pulled=false
  h.held=true
 end

 -- pulling the hammer
 if h.pulled then
  if h.x>p.x then
   h.dx-=h.ax
  else
   h.dx+=h.ax
  end
 end

 -- throwing the hammer
 if h.thrown then
  h.held=false
  if h.flipped then
   h.dx-=h.ax
  else
   h.dx+=h.ax
  end
 end

 -- check collision
 if collide_map(h,"left",1) or collide_map(h,"right",1) then
  if not h.pulled then
   h.dx=0
  end
 end

end

-- update
function _update()
 player_update()
 hammer_update()
end

-- draw
function _draw()
 cls()
 map(0,0)
 spr(p.spr,p.x,p.y,1,1,p.flipped)
 spr(h.spr,h.x,h.y)
end
__gfx__
00000000009999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700009999090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000990900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000009999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55666655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55666655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00044000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00066000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00044000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00066000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00044000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333bbbbbbbb11111111ddddddddcccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333bbbbbbbb11111111ddddddddcccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333bbbbbbbb11111111ddddddddcccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333bbbbbbbb11111111ddddddddcccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333bbbbbbbb11111111ddddddddcccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333bbbbbbbb11111111ddddddddcccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333bbbbbbbb11111111ddddddddcccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333bbbbbbbb11111111ddddddddcccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
4444444444444444444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444444444444444444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444444444444444444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444444444444444444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444444444444444444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444444444444444444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444444444444444444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4244444444444444444444444444444200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4244444444444444444444444444444200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4244444444444242424244444444444200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4244444444444444444444444442424200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4244444444444444444444444442424200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4242424242424242424242424242424200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4242424242424242424242424242424200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4242424242424242424242424242424200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4242424242424242424242424242424200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
